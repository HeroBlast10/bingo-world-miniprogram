<!--pages/game/game.wxml-->
<view class="container">
  <!-- 加载状态 -->
  <view class="loading" wx:if="{{isLoading}}">
    <text>加载中...</text>
  </view>

  <!-- 游戏内容 -->
  <view class="game-content" wx:else>
    <!-- 游戏头部信息 -->
    <view class="game-header" wx:if="{{game}}">
      <!-- 小程序标识 -->
      <text class="app-brand">小程序@宾了个果</text>
      <!-- 显示游戏标题和描述，以及修改按钮（用户创建的宾果才显示） -->
      <view class="title-row">
        <text class="game-title">{{game.title}}</text>
        <button 
          class="edit-button" 
          wx:if="{{game.creator === '我' && !isEditMode}}"
          bindtap="onEditGame"
          size="mini"
          type="primary"
        >修改</button>
        <button 
          class="edit-button complete-button" 
          wx:if="{{game.creator === '我' && isEditMode}}"
          bindtap="onCompleteEdit"
          size="mini"
          type="default"
        >完成</button>
      </view>
      <text class="game-description" wx:if="{{game.description && game.description.trim() !== '' && game.description !== '五个连成一线...'}}">
        {{game.description}}
      </text>
    </view>

    <!-- 宾果网格 -->
    <view class="bingo-container" wx:if="{{game}}">
      <view class="grid-container">
        <!-- 使用两层嵌套的 wx:for 来遍历 game.gridContent -->
        <!-- 外层 wx:for-index 为 rowIndex -->
        <view
          class="grid-row"
          wx:for="{{game.gridContent}}"
          wx:for-index="rowIndex"
          wx:key="rowIndex"
        >
          <!-- 内层为 colIndex -->
          <view
            class="cell {{selectedCells[rowIndex][colIndex] ? 'selected selected-' + selectedColor : ''}} {{isEditMode ? 'edit-mode' : ''}}"
            wx:for="{{item}}"
            wx:for-index="colIndex"
            wx:key="colIndex"
            data-row-index="{{rowIndex}}"
            data-col-index="{{colIndex}}"
            bindtap="{{isEditMode ? 'handleCellEdit' : 'handleCellClick'}}"
          >
            <!-- 显示单元格文本 -->
            <text class="cell-text {{item.textSizeClass}}">{{item.text}}</text>
            <!-- 编辑模式下显示编辑图标 -->
            <view class="edit-icon" wx:if="{{isEditMode}}">✏️</view>
          </view>
        </view>
      </view>
    </view>

    <!-- 底部导航栏 -->
    <view class="bottom-nav" wx:if="{{game}}">
      <view class="nav-item" bindtap="onSaveGame">
        <view class="nav-icon">💾</view>
        <text class="nav-text">保存</text>
      </view>
      <view class="nav-item" bindtap="onDownloadGame">
        <view class="nav-icon">📥</view>
        <text class="nav-text">下载</text>
      </view>
      <view class="nav-item" bindtap="onShareGame">
        <view class="nav-icon">📤</view>
        <text class="nav-text">分享</text>
      </view>
    </view>

    <!-- 隐藏的canvas用于生成图片 -->
    <canvas
      canvas-id="bingoCanvas"
      class="hidden-canvas"
      style="width: 1200px; height: 1680px; position: absolute; left: -9999px; top: -9999px;"
    ></canvas>
    
    <!-- 隐藏的canvas用于生成分享图片 -->
    <canvas
      canvas-id="shareCanvas"
      class="hidden-canvas"
      style="width: 400px; height: 400px; position: absolute; left: -9999px; top: -9999px;"
    ></canvas>
  </view>
</view>